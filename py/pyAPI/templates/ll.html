<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>å…¨ç½‘è§†é¢‘æ’­æ”¾æœåŠ¡</title>
</head>
<body>

<div id="app">
    <div class="liu-playContainer" v-show="ok">
        <button class="liu-closePlayer liu-btn" @click="closePlayer">
            Close Player
        </button>

        <div class="playSpace">
            <div class="artplayer-app"></div>
            <div class="series">
                <div class="seletor-title">é€‰é›†</div>
                <div class="series-contianer">
                    <button
                            class="series-selector liu-btn"
                            :class="{'playing':index==playingIndex}"
                            style="color: #a3a3a3"
                            v-for="(item,index) in playingList"
                            :key="index"
                            @click="playListSelect(index)"
                    >
                        {{ item.name.slice(0,4) }}
                    </button>
                </div>
            </div>
        </div>

        <div class="sourceButtonList">
            <button
                    class="source-selector liu-btn"
                    v-for="(item,index) in sources"
                    :key="index"
                    :class="{'selected':index==selectedSource,'speed-fast':item.speed>1}"
                    @click="sourceSelect(index)"
            >
                {{ item.name }} {{ item.speed }} m/s
            </button>
        </div>

        <p class="authoralert">è¯·ä¸è¦ç›¸ä¿¡è§†é¢‘ä¸­çš„å¹¿å‘Šï¼</p>
        <div class="mannul">
            <a class="love-support" style="text-decoration: #447006 wavy underline;" href="https://memos.babelgo.cn/m/1"
               target="_blank">â˜•èµä½œè€…å–ä¸€æ¯å’–å•¡ï¼Ÿ</a>
            <a class="love-support" href="https://t.me/wzxhhgy" target="_blank">ç”µæŠ¥ç¾¤</a>
            <a class="love-support"
               href="https://greasyfork.org/zh-CN/scripts/459540-%E6%88%91%E5%8F%AA%E6%83%B3%E5%A5%BD%E5%A5%BD%E8%A7%82%E5%BD%B1/feedback"
               target="_blank">ğŸ‘‰åé¦ˆ</a>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue@2.7.14"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/artplayer@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/axios@latest"></script>

<script>
    const _debug = 0; //@note debug
    const searchSource = [
        //@note å†…ç½®æœç´¢æº
        {
            name: "çº¢ç‰›èµ„æº",
            searchUrl: "https://www.hongniuzy2.com/api.php/provide/vod/from/hnm3u8/",
        },
        {
            name: "æš´é£èµ„æº",
            searchUrl: "https://bfzyapi.com/api.php/provide/vod/",
        },
        {
            name: "å¿«å¸†èµ„æº",
            searchUrl: "https://api.kuaifan.tv/api.php/provide/vod/",
        },
        {
            name: "éå‡¡èµ„æº",
            searchUrl: "http://cj.ffzyapi.com/api.php/provide/vod/",
        },
        {
            name: "é‡å­èµ„æº",
            searchUrl: "https://cj.lziapi.com/api.php/provide/vod/",
        },
        {
            name: "ikunèµ„æº",
            searchUrl:
                "https://ikunzyapi.com/api.php/provide/vod/from/ikm3u8/at/json/",
        },
        {
            name: "å…‰é€Ÿèµ„æº",
            searchUrl: "https://api.guangsuapi.com/api.php/provide/vod/from/gsm3u8/",
        },
        {
            name: "é«˜æ¸…èµ„æº",
            searchUrl: "https://api.1080zyku.com/inc/apijson.php/",
        },
        {
            name: "å¤©ç©ºèµ„æº",
            searchUrl:
                "https://m3u8.tiankongapi.com/api.php/provide/vod/from/tkm3u8/",
        },
        {
            name: "é—ªç”µèµ„æº",
            searchUrl: "https://sdzyapi.com/api.php/provide/vod/",
        },
        {
            name: "ç´¢å°¼èµ„æº",
            searchUrl: "https://suoniapi.com/api.php/provide/vod/",
        },
    ];

    const {query: $, queryAll: $$, isMobile} = Artplayer.utils;
    const tip = (message) => alert(message);

    // åˆ¤æ–­æ˜¯å¦ä¸º Edge æµè§ˆå™¨
    const isEdge = /Edge\/\d+/.test(navigator.userAgent);

    // åˆ¤æ–­æ˜¯å¦ä¸º Chrome æµè§ˆå™¨
    const isChrome = /Chrome\/\d+/.test(navigator.userAgent) && !isEdge;

    // åˆ¤æ–­æ˜¯å¦ä¸º Safari æµè§ˆå™¨
    const isSafari = /Safari\/\d+/.test(navigator.userAgent) && !isChrome;

    //--------------------------å…¨å±€æ–¹æ³•
    //è·å–è±†ç“£å½±ç‰‡åç§°
    const videoName = "çŒå†°";

    // debugæ–¹æ³•
    const log = (function () {
        if (_debug) return console.log.bind(console);
        return function () {
        };
    })();

    const htmlToElement = function (html) {
        //å°†htmlè½¬ä¸ºelement
        const template = document.createElement("template");
        template.innerHTML = html.trim();
        return template.content.firstChild;
    };

    //é€Ÿåº¦ä¸º0ä¸ä¸€å®šæ˜¯æ— æ³•æ’­æ”¾ï¼Œå¯èƒ½æ˜¯æºçš„é˜²ç«å¢™é˜»æ­¢äº†æµ‹é€Ÿï¼Œä¹Ÿå¯ä»¥è¯•è¯•ã€‚
    const handleResponse = function (response) {
        console.log("æ­£åœ¨å¤„ç†æœç´¢çš„ç»“æœ");
        if (!response) {
            console.log("è¿”å›ç»“æœé”™è¯¯,response is undefined");
            return {r: false};
        }
        if (response.list.length == 0) {
            console.log("æ²¡æœ‰æœç´¢åˆ°ç»“æœ");
            return {r: false};
        }
        let video, found = false;

        for (let item of response.list) {
            // å¯¹æ¯”åç§°ã€å‘è¡Œå¹´ã€æ¼”å‘˜ï¼Œåªè¦æœ‰ä¸€ä¸ªä¸€æ ·å°±ç®—æˆåŠŸ
            let nameEqual = item.vod_name == videoName;
            let yearEqual = getVideoYear(item.vod_year);
            let actorContain = videoActor(item.vod_actor.split(",")[0]);

            if (yearEqual === true || actorContain === true || nameEqual === true) {
                video = item;
                found = true;
                console.log(`èµ„æºåŒ¹é…æˆåŠŸ`);
                break;
            }
        }
        if (found == false) {
            return {r: false};
        }

        let playList = video.vod_play_url
            .split("$$$")
            .filter((str) => str.includes("m3u8"));
        if (playList.length == 0) {
            throw new Error("æ²¡æœ‰m3u8èµ„æº, æ— æ³•æµ‹é€Ÿ, æ— æ³•æ’­æ”¾");
            return {r: false};
        }
        playList = playList[0].split("#");
        playList = playList.map((str) => {
            let index = str.indexOf("$");
            return {
                name: str.slice(0, index),
                url: str.slice(index + 1),
                speed: -1,
            };
        });
        return {r: true, content: playList};
    };

    const playM3u8 = function (video, url, art) {
        if (Hls.isSupported()) {
            if (art.hls) art.hls.destroy();
            const hls = new Hls();
            hls.loadSource(url);
            hls.attachMedia(video);
            art.hls = hls;
            art.on("destroy", () => hls.destroy());
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
            video.src = url;
        } else {
            art.notice.show = "Unsupported playback format: m3u8";
        }
    };
    //è·å–ç”µå½±çš„å¹´ä»½
    const getVideoYear = function (outYear) {
        const e = $(isMobile ? ".sub-original-title" : ".year");
        if (!e) {
            console.log("è·å–å¹´ä»½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼");
            return 0;
        }
        return e.innerText.includes(outYear);
    };

    //å¯¹æ¯”ç”µå½±æ¼”å‘˜
    const videoActor = function (outActor) {
        const e = $(isMobile ? ".bd" : ".actor");
        if (!e) {
            console.log("è·å–æ¼”å‘˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼");
            return 0;
        }
        //console.log(`${outActor}ï¼šåŒ¹é…ç»“æœ${e.innerText.includes(outActor)}`)
        return e.innerText.includes(outActor);
    };

    //ä¸‹è½½
    const get = function (detail) {
        console.log("æ­£åœ¨è¯·æ±‚ï¼š");
        console.log(detail);

        return new Promise((resolve, reject) => {
            let xhr = new XMLHttpRequest();
            xhr.open(detail.method || "GET", detail.url, true);
            xhr.timeout = detail.timeout || 3000;

            xhr.onload = function () {
                resolve({r: true, content: xhr.response});
            };

            xhr.onerror = function () {
                console.log("getè¯·æ±‚error" + detail.url);
                reject({r: false});
            };

            xhr.onabort = function () {
                console.log("getè¯·æ±‚abort" + detail.url);
                reject({r: false});
            };

            xhr.ontimeout = function () {
                console.log("getè¯·æ±‚timeout" + detail.url);
                reject({r: false});
            };

            // è®¾ç½® CORS ç›¸å…³å¤´éƒ¨
            xhr.withCredentials = true; // å¦‚æœéœ€è¦å¸¦ä¸Šè®¤è¯ä¿¡æ¯
            xhr.setRequestHeader('Content-Type', 'application/json'); // è®¾ç½®è¯·æ±‚å¤´

            // You may need to handle other properties from detail here

            xhr.send();
        });
    };

    //ä¸‹è½½m3u8çš„å†…å®¹ï¼Œè¿”å›ç‰‡æ®µåˆ—è¡¨
    const downloadtsList = async function (url) {
        let domain = url.split("/")[0];
        let baseUrl = url.split("/")[2];
        let result = await get({
            url: encodeURI(url),
        });

        if (!result.r) {
            return {r: false};
        }
        let downloadContent = result.content;

        if (!downloadContent.includes("#EXTM3U")) {
            console.log("æ— æ³•è·å–m3u8å†…å®¹ï¼Œè¯·æ±‚ç½‘å€ä¸ºï¼š" + url);
            console.log("ä¸‹è½½çš„å†…å®¹ä¸º");
            console.log(downloadContent);
            return {r: false};
        }
        let tsList = [];
        if (downloadContent.includes(".m3u8")) {
            //å¦‚æœè¿˜æ˜¯m3u8åœ°å€
            let lines = downloadContent.split("\n");
            for (let item of lines) {
                if (/^[#\s]/.test(item)) continue; //è·³è¿‡æ³¨é‡Šå’Œç©ºç™½è¡Œ
                if (item == "") continue;
                if (/^\//.test(item)) {
                    //å¦‚æœæ˜¯ç›¸å¯¹é“¾æ¥çš„è¯
                    let result = await downloadtsList(domain + "//" + baseUrl + item);
                    if (!result.r) {
                        return {r: false};
                    }
                    tsList = result.content;
                } else if (/^https?:\/\//i.test(item)) {
                    //å¦‚æœæ˜¯ç»å¯¹é“¾æ¥çš„è¯
                    let result = await downloadtsList(item);
                    if (!result.r) {
                        return {r: false};
                    }
                    tsList = result.content;
                } else {
                    //é‚£å°±åªå‰©ä¸‹æ›¿ä»£é“¾æ¥çš„æƒ…å†µäº†
                    console.log("m3u8æ›¿ä»£æƒ…å†µ");
                    console.log(item);
                    let contents = url.split("/");
                    contents[contents.length - 1] = item;
                    console.log(contents);
                    url = contents.join("/");
                    let result = await downloadtsList(url);
                    if (!result.r) {
                        return {r: false};
                    }
                    tsList = result.content;
                }
            }
            return {r: true, content: tsList};
        }
        if (downloadContent.includes(".ts")) {
            //å¦‚æœæ˜¯tsåœ°å€
            let lines = downloadContent.split("\n");
            for (let item of lines) {
                if (/^[#\s]/.test(item)) continue; //è·³è¿‡æ³¨é‡Šå’Œç©ºç™½è¡Œ
                if (item == "") continue;
                if (/^https?:\/\//i.test(item)) {
                    //å¦‚æœæ˜¯httpç›´é“¾
                    tsList.push(item);
                } else if (/^\//.test(item)) {
                    //å¦‚æœæ˜¯ç›¸å¯¹é“¾æ¥
                    tsList.push(domain + "//" + baseUrl + item);
                } else {
                    //å¦‚æœä¸æ˜¯ç›¸å¯¹é“¾æ¥å°±æŠŠindex.m3u8æ›¿æ¢æ‰å°±è¡Œ
                    let contents = url.split("/");
                    contents[contents.length - 1] = item;
                    url = contents.join("/");
                    tsList.push(url);
                }
            }
            console.log(`æµ‹è¯•åˆ—è¡¨ä¸º:`);
            console.log(tsList);
            return {r: true, content: tsList};
        }

        console.log("æœªçŸ¥çŠ¶å†µ");
        console.log(downloadContent);
        return {r: false};
    };

    //æ„å»ºvueçš„å®ä¾‹
    function initVue() {
        //@note initVue
        let vueInstance = new Vue({
            el: "#app",
            data: {
                //artplayerå®ä¾‹
                art: {},
                //æ ‡æ˜æ˜¯å¦æœåˆ°å½±ç‰‡
                ok: false,
                //æœç´¢æº
                searchSource: searchSource,
                //æ ‡è®°æ­£åœ¨ä¸‹è½½çš„èµ„æºï¼Œå¥½debug
                sourceTesting: "",

                //æ‰€æœ‰æœç´¢åˆ°çš„èµ„æº [{name:"..èµ„æº",playList:[{name:"ç¬¬ä¸€é›†",url:""}]}]
                sources: [],
                //æ ‡è®°é€‰æ‹©çš„æº
                selectedSource: 0,
                //æ­£åœ¨æ’­æ”¾çš„é€‰é›†æ€»è¡¨
                playingList: [],
                //æ­£åœ¨æ’­æ”¾å“ªä¸€é›†
                playingIndex: 0,
                //å’–å•¡åœ°å€
                coffeeUrl: "https://memos.babelgo.cn/m/1",
                //telegramåœ°å€
                telegramUrl: "https://t.me/wzxhhgy",
                //greasyforkåé¦ˆåœ°å€
                feedbackUrl:
                    "https://greasyfork.org/zh-CN/scripts/459540-%E6%88%91%E5%8F%AA%E6%83%B3%E5%A5%BD%E5%A5%BD%E8%A7%82%E5%BD%B1/feedback",
            },
            methods: {
                //@note mergeè‡ªå®šä¹‰æº

                //æµ‹è¯•é€Ÿåº¦
                async testSpeed() { //@note testSpeed
                    //this.sources //æ‰€æœ‰æœç´¢åˆ°çš„èµ„æº [{name:"..èµ„æº",playList:[{name:"ç¬¬ä¸€é›†",url:""}]}]
                    await Promise.all(
                        this.sources.map(async (source, index) => {
                            try {
                                let name = source.name;
                                let url = source.playList[this.playingIndex].url;
                                console.log("å¼€å§‹æµ‹é€Ÿï¼š" + url)
                                let result = await downloadtsList(url);
                                // å¦‚æœæ— æ³•è·å–index.m3u8 å°±ç›´æ¥æ— æ³•æµ‹é€Ÿ
                                if (!result.r) {
                                    this.sources[index].speed = 0;
                                    this.$forceUpdate();
                                    return;
                                }
                                let tsList = result.content
                                console.log("downloadList")
                                console.log(tsList)
                                //éšæœºé€‰æ‹©8ä¸ªåˆ‡ç‰‡ä¸‹è½½
                                if (tsList.length > 10) {
                                    tsList = tsList.slice(0, 10)
                                } else {
                                    tsList = tsList.slice(0, tsList.length - 1)
                                }
                                let downloadSize = 0;
                                let startTime = Date.now();
                                console.log("å°†è¦æµ‹è¯•çš„åˆ—è¡¨ä¸ºï¼š")
                                console.log(tsList)
                                for (let item of tsList) {

                                    let result = await get({
                                        url: encodeURI(item),
                                        responseType: "arraybuffer",
                                    });
                                    if (!result.r) {
                                        downloadSize += 0
                                    } else {
                                        let response = result.content;
                                        downloadSize += response.byteLength
                                            ? response.byteLength / 1024 / 1024
                                            : 0;
                                    }
                                }
                                let endTime = Date.now();
                                let duration = (endTime - startTime) / 1000;
                                let speed =
                                    downloadSize / duration ? downloadSize / duration : 0;
                                this.sources[index].speed = Number(speed.toFixed(2));
                                this.$forceUpdate();
                                console.log(`${name}çš„é€Ÿåº¦ä¸º${speed}mb/s`);
                            } catch (e) {
                                console.log(e);
                                this.sources[index].speed = 0;
                                this.$forceUpdate();
                            }
                        })
                    );
                },
                //é€‰æ‹©æºçš„æŒ‰é’®è¡Œä¸º
                sourceSelect(index) {
                    let ct = this.art.currentTime;
                    this.selectedSource = index;
                    this.playingList = this.sources[index].playList;
                    this.switchUrl(this.playingList[this.playingIndex].url);
                    this.art.once("video:canplay", () => {
                        this.art.seek = ct;
                    });
                    this.testSpeed().then(() => {
                        console.log("æµ‹é€Ÿå®Œæˆï¼");
                    });
                },
                //é€‰æ‹©å‰§é›†çš„æŒ‰é’®è¡Œä¸º
                playListSelect(index) {
                    this.playingIndex = index;
                    //æ‰“å°playlist
                    console.log(this.playingList);
                    this.switchUrl(this.playingList[this.playingIndex].url);
                },
                // åˆå§‹åŒ–Artæ’­æ”¾å™¨
                initArt(url) {
                    //@note initArt
                    this.art = new Artplayer({
                        container: ".artplayer-app",
                        url: url,
                        pip: true,
                        fullscreen: true,
                        fullscreenWeb: true,
                        autoMini: true,
                        screenshot: true,
                        hotkey: true,
                        airplay: true,
                        playbackRate: true,
                        setting: true,
                        miniProgressBar: true,
                        theme: "#00981a",
                        moreVideoAttr: {
                            crossOrigin: "anonymous",
                        },
                        controls: [
                            {
                                name: "resolution",
                                html: "åˆ†è¾¨ç‡",
                                position: "right",
                            },
                        ],
                        type: "m3u8",
                        customType: {
                            m3u8: playM3u8,
                        },
                        //   plugins: [artplayerPluginControl()],
                    });
                    this.art.on("video:loadedmetadata", () => {
                        this.art.controls.resolution.innerText =
                            this.art.video.videoHeight + "P";
                    });
                    console.log("åˆå§‹åŒ–artå®ä¾‹å®Œæˆï¼Œart:");
                    console.log(this.art);
                },
                //åˆ‡æ¢æ’­æ”¾å™¨çš„æ’­æ”¾url
                switchUrl(url) {
                    this.art.switchUrl(url);
                    //å…¼å®¹safari
                    if (this.art.video.src != url) {
                        this.art.video.src = url;
                    }
                },
                //å…³é—­é¡µé¢
                closePlayer() {
                    $("#app").remove();
                },

                async search(url) {
                    let splitVideoName = "";
                    if (videoName.length >= 3) {
                        splitVideoName = videoName.slice(0, 3);
                    } else {
                        splitVideoName = videoName;
                    }
                    console.log(`${url}?ac=detail&wd=${splitVideoName}`)
                    let result = await get({
                        url: encodeURI(`${url}?ac=detail&wd=${splitVideoName}`),
                        responseType: "json",
                        overrideMimeType: "application/json",
                    });
                    if (!result.r) {
                        return {r: false, content: "æœç´¢æ—¶ç½‘ç»œå‡ºç°å¼‚å¸¸"}
                    }
                    let response = result.content
                    return {r: true, content: response};
                },
                //å¤„ç†æœç´¢åˆ°çš„ç»“æœ:ä»è¿”å›ç»“æœä¸­æ‰¾åˆ°å¯¹åº”ç‰‡å­
            },
            async created() {
                //@note created
                //åˆå§‹åŒ–æ—¶å¼€å§‹æœç´¢æ‰€æœ‰èµ„æº, åˆå§‹åŒ–sources æ•°ç»„
                //merge ç”¨æˆ·æ·»åŠ çš„åœ°å€
                //this.mergeSource();
                //this.searchSource.forEach();
                await Promise.all(
                    this.searchSource.map(async (item) => {
                        //æ ‡è®°å½“å‰æ­£åœ¨å¤„ç†çš„èµ„æº
                        this.sourceTesting = item.name;
                        // searché‡Œè‡ªå¸¦è§£æå‡½æ•°ï¼Œæ‰€ä»¥åªè¦é€šè¿‡å°±è¯´æ˜æœç´¢åˆ°äº†
                        let result = await this.search(item.searchUrl);
                        if (!result.r) {
                            return {r: false, content: "æœç´¢å‡ºç°å¼‚å¸¸"}
                        }
                        let response = result.content
                        result = handleResponse(response);
                        console.log("resutl => ")
                        console.log(result)
                        if (result.r) {
                            console.log(`${item.name} æœåˆ°äº†`);
                            let playList = result.content
                            this.sources.push({name: item.name, playList});
                            if (this.ok == false) {
                                this.ok = true;
                                this.$forceUpdate();
                                this.playingList = playList;
                                this.initArt(this.playingList[0].url);
                            }
                        } else {
                            console.log(`${item.name}æ²¡æ‰¾åˆ°`)
                        }
                    })
                );

                // æ­¤æ—¶è¿˜ä¸èƒ½æ£€æµ‹æ˜¯å¦å·²ç»æœç´¢å®Œæ¯•ï¼Œå› ä¸ºå‰é¢å‘çš„æ˜¯async
                // å› ä¸ºSafariçš„xmlhttpæ–¹æ³•åœ¨å¤±è´¥æ—¶ä¸ä¼šè¿”å›rejectå¯¼è‡´Promiseä¸€ç›´ç­‰å¾…ï¼Œ
                // å¯¼è‡´åé¢çš„ä»£ç æ— æ³•æ‰§è¡Œ,æ‰€ä»¥éœ€è¦æ‰‹åŠ¨å®ç°timeoutæœºåˆ¶
                // ç»“æŸä»¥åokè¿˜ä¸ºfalseè¯´æ˜æ²¡æœç´¢
                if (this.ok == true) {
                    //å¼€å§‹æµ‹é€Ÿ
                    if (isSafari) {
                        tip("å¾ˆå¯æƒœï¼ŒSafariæµè§ˆå™¨å­˜åœ¨ä¸¥é‡Bugï¼Œæ‰€ä»¥æµ‹é€ŸåŠŸèƒ½å·¥ä½œä¸æ­£å¸¸ã€‚");
                    }
                    console.log("å¼€å§‹æµ‹é€Ÿ")
                    await this.testSpeed();
                } else {
                    tip(
                        "æœªæœç´¢åˆ°èµ„æºï¼Œå¯èƒ½æ˜¯è±†ç“£çš„ç”µå½±åç§°å’Œèµ„æºç«™çš„åç§°ä¸ä¸€è‡´ï¼Œè¯·åé¦ˆç”µå½±åç§°ã€‚"
                    );
                    window.open(
                        "https://greasyfork.org/zh-CN/scripts/459540-%E6%88%91%E5%8F%AA%E6%83%B3%E5%A5%BD%E5%A5%BD%E8%A7%82%E5%BD%B1/feedback"
                    );
                }
            },
        });
    }

    initVue();
</script>

</body>
</html>
